"use strict";angular.module("hellbergApp",["ngRoute","ngAutocomplete","angulartics","angulartics.google.analytics"]).constant("LOCALE",{lang:"en",locale:"en_GB"}).constant("SOUNDTRACK",{url:"resources/kobenhavns-jernbane-damp-galop.m4a",section:{start:75,end:248}}).directive("focusMe",function(){return{scope:{trigger:"=focusMe"},link:function(a,b){a.$watch("trigger",function(c){c===!0&&(b[0].focus(),a.trigger=!1)})}}}).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/trip/:dep_ref/:dest_ref/",{templateUrl:"views/trip.html",controller:"TripCtrl"}).when("/result/:score/:answer/",{templateUrl:"views/result.html",controller:"ResultCtrl"}).otherwise({redirectTo:"/"})}]);var Answer=function(a){("undefined"==typeof a||null===a)&&(a={});var b={answers:[],threshold:.65};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};Answer.prototype.threshold_value=function(){return this.threshold},Answer.prototype.get_answers=function(){return this.answers},Answer.prototype.add_answer=function(a){return this.answers.push(a)},Answer.prototype.evaluate_answer=function(a){var b=[];a=a.toLowerCase();for(var c,d=0;d<this.answers.length;d++)c=this.answers[d],b.push(new Levenshtein(c.toLowerCase(),a));return b},Answer.prototype.answer_score=function(a){var b=this.evaluate_answer(a),c=Number.MAX_VALUE;if(b.length<1)return c;var d;for(d=0;d<b.length;d++){var e=b[d],f=e.distance;c>f&&(c=f)}return c},Answer.prototype.validate_answer=function(a){var b=this.answer_score(a);return b<this.score_threshold()},Answer.prototype.score_threshold=function(){if(this.answers.length<1)return 0;var a,b,c=0;for(b=0;b<this.answers.length;b++)c+=this.answers[b].length;return a=Math.round(c/this.answers.length),a*this.threshold_value()};var HB=window.Hellberg||{};HB.Answer=Answer,window.Hellberg=HB,String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var QuestionTemplate=function(a){("undefined"==typeof a||null===a)&&(a={});var b={template_string:null,location:null};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};QuestionTemplate.prototype.template=function(){return this.template_string},QuestionTemplate.prototype.departure_synonyms=["our point of departure","our starting location"],QuestionTemplate.prototype.destination_synonyms=["our destination","the destination of our trip"],QuestionTemplate.prototype.departure_synonym=function(a){return this._random_array_idx(this.departure_synonyms,a)},QuestionTemplate.prototype.destination_synonym=function(a){return this._random_array_idx(this.destination_synonyms,a)},QuestionTemplate.prototype.location_synonym=function(a){return this.location.type===Hellberg.TripLocation.prototype.LOCATION_TYPE_DEPARTURE?this._random_array_idx(this.departure_synonym,a):this._random_array_idx(this.destination_synonyms,a)},QuestionTemplate.prototype._random_array_idx=function(a,b){return("undefined"==typeof a||null===a)&&(a=[]),("undefined"==typeof b||null===b)&&(b=-1),a.length?a[Math.floor(Math.random()*a.length)]:void 0};var VenueQuestionTemplate=function(a){("undefined"==typeof a||null===a)&&(a={}),QuestionTemplate.call(this,a);var b={format:"%s is a popular %s at %s.",name:null,category:null};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};VenueQuestionTemplate.prototype=new QuestionTemplate,VenueQuestionTemplate.prototype.constructor=QuestionTemplate,VenueQuestionTemplate.prototype.question=function(){return sprintf(this.format,this.name,this.category.toLowerCase(),this.location_synonym().toLowerCase())};var FactQuestionTemplate=function(a){("undefined"==typeof a||null===a)&&(a={}),QuestionTemplate.call(this,a);var b={format:"%s"};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};FactQuestionTemplate.prototype=new QuestionTemplate,FactQuestionTemplate.prototype.constructor=QuestionTemplate,FactQuestionTemplate.prototype.template_fillers=["Humpty-Dumpty","Schmoodie","Bogus","Hocus Pocus","Rickety Roo"],FactQuestionTemplate.prototype.question=function(){var a=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a},b=[this.format,this.location_synonym()],c=this.template_fillers;c=a(c),b.push.apply(b,c);var d=sprintf.apply(this,b);return d.capitalize()};var HB=window.Hellberg||{};HB.QuestionTemplate=QuestionTemplate,HB.VenueQuestionTemplate=VenueQuestionTemplate,HB.FactQuestionTemplate=FactQuestionTemplate,window.Hellberg=HB;var Question=function(a){("undefined"==typeof a||null===a)&&(a={});var b={index:-1,question:null,answer:null};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};Question.prototype.validate_answer=function(a){return this.answer.validate_answer(a)};var ImageQuestion=function(a){("undefined"==typeof a||null===a)&&(a={}),Question.call(this,a);var b={image:null};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};ImageQuestion.prototype=new Question,ImageQuestion.prototype.constructor=Question;var HB=window.Hellberg||{};HB.Question=Question,HB.ImageQuestion=ImageQuestion,window.Hellberg=HB;var QuestionSet=function(a){("undefined"==typeof a||null===a)&&(a={});var b={questions:[]};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};QuestionSet.prototype.questions=function(){return this.questions},QuestionSet.prototype.get_question=function(a){return this.questions[a]},QuestionSet.prototype.set_question=function(a,b){a.index=b,this.questions[b]=a},QuestionSet.prototype.add=function(a){return console.log(a),a.index<0?(a.index=this.questions.length,this.questions.push(a)):this.set_question(a,a.index)};var HB=window.Hellberg||{};HB.QuestionSet=QuestionSet,window.Hellberg=HB;var TripLocation=function(a){("undefined"==typeof a||null===a)&&(a={});var b={name:null,coordinate:{lat:0,lng:0},type:TripLocation.prototype.LOCATION_TYPE_DESTINATION};for(var c in b){var d=null;d=c in a?a[c]:b[c],this[c]=d}};TripLocation.prototype.LOCATION_TYPE_DEPARTURE="departure",TripLocation.prototype.LOCATION_TYPE_DESTINATION="destination";var HB=window.Hellberg||{};HB.TripLocation=TripLocation,window.Hellberg=HB;var txtwiki=function(){function a(a){var b="";a=h(a),a=e(a),a=f(a);for(var c=a.split("\n"),d=0;d<c.length;d++)0!==c[d].length?(c[d]=g(c[d]),b+=c[d]+"\n"):b+="\n";return b=h(b)}function b(a,b,c,d){if(a.slice(b,b+c.length)==c){b+=c.length;var e=a.indexOf(d,b);return-1==e&&(e=a.length),{text:a.slice(b,e),pos:e+d.length}}return{text:null,pos:b}}function c(a,b){if("[["==a.slice(b,b+2)){var d="";for(b+=2;"]]"!=a.slice(b,b+2);)if("[["==a.slice(b,b+2)){var e=c(a,b);d+=e.text,b=e.pos}else d+=a[b],b++;b+=2;var f=d.split("|");return 1==f.length?{text:f[0],pos:b}:"File:"==f[0].slice(0,5)?{text:"",pos:b}:{text:f[1],pos:b}}return{text:null,pos:b}}function d(a,b){if("<ref"==a.slice(b,b+4)){b+=4;var c=a.slice(b),d=c.search(/<\/ref>|\/>/);return"</ref>"==c.slice(d,d+6)?{text:c.slice(0,d),pos:b+d+6}:{text:c.slice(0,d),pos:b+d+2}}return{text:null,pos:b}}function e(a){for(var c,d="",e=0;e<a.length;)"<"!=a[e]||(c=b(a,e,"<!--","-->"),null==c.text)?"{"!=a[e]||(c=b(a,e,"{|","|}"),null==c.text)?(d+=a[e],e++):e=c.pos:e=c.pos;return d}function f(a){for(var b,e="",f=0;f<a.length;)"<"!=a[f]||(b=d(a,f),null==b.text)?"["!=a[f]||(b=c(a,f),null==b.text)?(e+=a[f],f++):(f=b.pos,e+=b.text):f=b.pos;return e}function g(a){for(var b=[],c=0,d=0,e=a,f=0,g=0;;){if(f=e.search(/''([^']|$)/),-1===f)break;g+=f,"'''"===e.slice(f-3,f)?(b.push({pos:g-3,type:"b"}),b.push({pos:g,type:"i"}),d+=1,c+=1):"'"===e[f-1]?(b.push({pos:g-1,type:"b"}),d+=1):(b.push({pos:g,type:"i"}),c+=1),g+=2,e=e.slice(f+2)}if(d%2+c%2===2)for(f=0;f<b.length;f++)if("b"===b[f].type&&(void 0===b[f+1]||b[f+1].pos-b[f].pos!==3)){g=b[f].pos,(" "===a[g-2]&&" "!==a[g-2]||" "!==a[g-2]&&" "!==a[g-2]||" "===a[g-2])&&(b[f].pos+=1,b[f].type="i",d-=1,c+=1);break}c%2===1&&(b.push({pos:a.length,type:"i"}),a+="''"),d%2===1&&b.push({pos:a.length,type:"b"});var h="";if(0!==b.length){for(g=0,f=0;f<b.length;f++)h+=a.slice(g,b[f].pos),g="b"===b[f].type?b[f].pos+3:b[f].pos+2;"''"!==a.slice(a.length-2,a.length)&&(h+=a.slice(g,a.length))}else h=a;return h}function h(a){var b="";a=a.replace(/ +/g," ");for(var c=a.split("\n"),d=0;d<c.length;d++)b+=c[d].match(/^\s*$/)?"\n\n":c[d].match(/^==+.+==+$/)?c[d]+"\n":c[d];return b=b.replace(/\n\n+/g,"\n\n"),b=b.replace(/(^\n*|\n*$)/g,"")}var i={parseWikitext:a};return"undefined"!=typeof module&&module.exports?(module.exports=i,void 0):i}();angular.module("hellbergApp").factory("Questions",["$http","$q","LOCALE",function(a,b,c){var d={},e="MURHMAGAPKW5ZAXYEEPFC30BALAU0D4CZYLRRWOMEKIDLV2C",f="TI0FW2KG2NPVFP20TSMIBSYALQJ4XM0I2WFMBXB3JTXPJMHU",g=function(b){return a.jsonp(b)},h=function(a){var b="http://"+c.lang+".wikipedia.org/w/api.php?action=query&format=json&callback=JSON_CALLBACK&prop=revisions&rvprop=content&titles="+encodeURIComponent(a);return g(b)},i=function(a){var b="https://api.foursquare.com/v2/venues/explore?ll="+encodeURIComponent(a.lat)+","+encodeURIComponent(a.lng)+"&v=20131207&callback=JSON_CALLBACK";return b+="&client_id="+encodeURIComponent(e),b+="&client_secret="+encodeURIComponent(f),g(b)};return d.fetch=function(a,c,d){var e=new Hellberg.TripLocation({name:c,coordinate:{lat:d.length?d[d.length-1].lat:0,lng:d.length?d[d.length-1].lng:0},type:Hellberg.TripLocation.prototype.LOCATION_TYPE_DESTINATION}),f=new Hellberg.Answer({answers:[e.name]}),g=[],j=function(a){var b=a.data,c=25;for(var d in b.query.pages){var g=b.query.pages[d],h=g.revisions.pop(),i=h["*"],j=i.toLowerCase(),k=j.indexOf("#redirect [[");if(0===k){i=i.substr(k+"#redirect [[".length),k=i.indexOf("]]");var l=i.substr(0,k);return{type:"redirect",name:l}}i=txtwiki.parseWikitext(i),i=i.replace(/^[  \s]*\|.*$/gi,""),i=i.replace(/[\s\n]+/gi," "),i=i.replace(/\{\{[^\}]*\}\}/gi,""),i=i.replace(/\([^\)]*[;][^\)]*\)/gi,""),i=i.replace(/([=]+[^=]+[=]+)/gi,""),i=i.replace(/[\s\n]+/gi," "),i=$("<div />").html(i).text(),i=i.replace(/%/gi,"%%"),i=i.replace(new RegExp(e.name,"gi"),"%s"),i=i.replace(/\s+,\s+/gi,", ");var m="#####";i=i.replace(/([\.\?!])\s+/gi,"$1"+m);for(var n=i.split(m),o=[],p=0;p<n.length;p++){var q=n[p];if(q.match(/%s/gi)&&q.length>c){var r=new Hellberg.FactQuestionTemplate({format:q.replace(/^\s+/gi,""),location:e}),s=new Hellberg.Question({question:r.question(),answer:f});o.push(s)}}return{type:"questions",questions:o}}},k=b.defer();h(e.name).then(function(a){var b=j(a);"redirect"===b.type?h(b.name).then(function(a){var b=j(a);console.log("wikidfd.resolve"),k.resolve(b)}):(console.log("wikidfd.resolve"),k.resolve(b.questions))});var l=b.defer();i(e.coordinate).then(function(a){for(var b=a.data.response.groups[0].items,c=0;c<b.length;c++){var d=b[c],h=d.venue.name,i=d.venue.categories[0].shortName;if(f.validate_answer(h)!==!0){var j=new Hellberg.VenueQuestionTemplate({name:h,category:i,location:e}),k=new Hellberg.Question({question:j.question(),answer:f});g.push(k)}}console.log("fsqdfd.resolve"),l.resolve(g)});var m=b.defer();return b.all([k.promise,l.promise]).then(function(a){var b=new Hellberg.QuestionSet,c=a[0],d=a[1],e=d.length-1,f=parseInt(Math.round(Math.random()),10),g=3,h=parseInt(Math.round(Math.random()*(g>e?e:g)),10),i=parseInt(Math.round(Math.random()),10),j=2+parseInt(Math.round(2*Math.random()),10);console.log("wikipedia_questions:",c),b.add(c[f]),b.add(c[1-f]),b.add(d[h]),b.add(c[j+i]),b.add(c[j+(1-i)]),m.resolve(b)}),m.promise},d}]),angular.module("hellbergApp").factory("RouteLoader",["$q",function(a){var b={},c=function(b,c){var d=a.defer(),e=new google.maps.places.PlacesService($("#attribution")[0]);e.getDetails({reference:b},function(a){d.resolve(a)});var f=a.defer();return e.getDetails({reference:c},function(a){f.resolve(a)}),a.all([d.promise,f.promise])},d=function(b,c){var d={origin:b,destination:c,travelMode:google.maps.TravelMode.DRIVING},e=a.defer(),f=new google.maps.DirectionsService;return f.route(d,function(a,b){b===google.maps.DirectionsStatus.OK&&e.resolve(a)}),e.promise};return b.fetch=function(b,e){var f=a.defer();return c(b,e).then(function(a){var b=a[0].name,c=a[1].name;d(b,c).then(function(b){f.resolve([a[0],a[1],b])})}),f.promise},b}]),angular.module("hellbergApp").factory("Speak",["LOCALE",function(a){var b,c={};return c.speak=function(c){if(!c)return!1;var d=["http://www.corsproxy.com/","translate.google.com/translate_tts?ie=UTF-8&q=",c,"&tl=",encodeURIComponent(a.locale)].join(""),e=new Audio;return e.addEventListener("play",function(){console.log("isSpeaking start")},!1),e.addEventListener("ended",function(){b=!0,console.log("isSpeaking end")},!1),e.addEventListener("error",function(a){console.log("error",a),console.log("isSpeaking end")},!1),e.autoplay=!0,e.src=d,e},c}]),angular.module("hellbergApp").factory("Soundtrack",["SOUNDTRACK",function(a){var b={},c=function(a,b,c,d,e){var f=b/c,g=-1,h=function(){g++;var b=d+(e-d)*(g/c);a.volume=b,c>g&&setTimeout(h,f)};h()},d=function(a,b,d){return c(a,b,d,0,1)},e=function(a,b,d){return c(a,b,d,1,0)};return b.play=function(){var b=new Audio;return b.addEventListener("play",function(){console.log("soundtrack start")},!1),b.addEventListener("ended",function(){console.log("soundtrack end")},!1),b.addEventListener("error",function(){console.log("error"),console.log("soundtrack error")},!1),b.addEventListener("canplay",function(){b.currentTime=parseInt(a.section.start,10)},!1),b.autoplay=!1,b.loop=!0,b.src=a.url,b.play(),d(b,1e4,8),b},b.fade_out=e,b}]),angular.module("hellbergApp").controller("MainCtrl",["$scope","$location",function(a,b){a.bg_image="images/cover/0"+Math.floor(Math.round(9*Math.random()))+".jpg",a.detail1=null,a.detail2=null,a.options={types:"(cities)"},a.trip=function(){a.detail1&&a.detail2?b.path("/trip/"+a.detail1.reference+"/"+a.detail2.reference+"/"):alert("Fill in both locations")},a.random=function(){var a=[["CoQBcgAAALrzKujSCi9rSiQ9Wgrs-SBHmUnvrCq8QzsMxqQv4KusGzTLcAZ96ZqxSGATL2EIEr95P17nO1DG8wW-drh-2Ij6Wkkk_Jr9XuKximoKE0HCZuQ7O2nDY7IpgFxHsHzb4pBPmklDr8_Hc4uGeexxSmUi9ArM3enuvZirJ0yEOpSyEhDIu_10N0PU7-d49nYgH4k9GhQrKv2_LeI8KbfXQbRDRidkRFtf6g","CoQBdgAAAJvNJN5K76_Oh2aJoSbpsNV8b_wLEhtbU3E4yg769Rb7Q7LwUTEJuqrEc_-UvNjMFw-rd8MWvFav0E6lUEjK6rzn_qeZgAAYxCzyEuunKg5qbW0Ha59eo8K7D9YlyUHYVqJS82_HX4snzG7nzBUvOzXvmWcDl6nKuk2T6MRYmoSdEhB0XMVZnhJsQHSOWKZnZjRGGhRc9iUByrDmgOubD_YHDbaEyUMOHA"],["CoQBcQAAAKcfVqHWQrV9kZg5BEj3ik9ihOaWm1h3yQeEblDqHFNcrLrzKLGwRD-DLdOTRzkn_NPyBaS1xws37gcaGjImSIQvhhbWKrVZgRmgdCa4n1bj8Tlz8ic-3AJB3WfbwMuOoNRjgiSJF7ED3-KkgivXA0w7bm7Lqz7aqZ5Q8ha2tJzQEhAwvYxoCZLUj4qcjuCbnfd2GhRR21kOUUOKV3y7nnMrSr1f8fYt-g","CnRvAAAAB3ntzBSgHW1VYtS69c-T0dBzH1CvJTs3DCkrLMNbGxXcJ6hkEn5PB8giXFHtVZ7aezijN_zxfi-J4qAGCg0MDeB48uGYtwNpYg1mkMaLcA1FjJGuBGvbP1X3XxKsbcYC-eWNyIOnihpb84cM5aPFXBIQ45jym9e6bNMFbZFf4W6DUxoUlTDhPiSgGCx06tsFrU-pmw88WQc"],["CoQBcgAAAAXDvviSwTCDorP6etcMsJGHook-mF7HitzAlTESEV2tATHmYxHFABHe6dUg--_ize-binVXnarvP1ksfigTm3RBdfsnCAqrVwxPm0Tn1_ZQlTE182ybBI77UwKuRy3trNAoY3VdxVqY5qyBPP_7cJI3xLR8D4J4g1Ujbp9cukr5EhD0S_tOb86Xd_DunS_6hw3dGhSr585ajh2-ZouLhZSDvc9sYkcXIg","CoQBdAAAAN5GuBaVDR3ZsDZEVpGOxZ1V9EwtZTkJHSfcqJGSyG5J_yyQTWm3jExGRRTihSj-xRKk6AHJPrBva1kSjwRxT_iNJCq7uJqOQExIgvHMLvUFnRzHXT1iuprvAXQt1_1U5hhjsWSjMPWkZNa88vcnoH_e9AMXbFkgtnCAfCdJpBUoEhBuQ8TxDf83hLPrR8tVLvCjGhSZ9yA7tgb_FVgFo9dTEDBNidflkw"],["CoQBcgAAANHnKbWNcmxd76TARBxbSj5Fc89B0gR3ooak5C3jneiDmbjgTeaGCR2luQ2daZfBVCCNvF63Yb2m4NEKDJBheWX_uJRwdYGqb2Tyo_4TMCLsCw4FsBZkGetpldQY0TJoITNgia6jSs8PCfq2P_e2wXrlDFF0Eq7ZrqSssg7dLRDuEhABZVM4b1Riu2EEuknXCRyEGhQ5NpdUE3afnr9zKfsG2sNPrjufCA","CoQBcwAAAAgARr7YUjaYXLcKNiUJfLK9Uh4Ho8MEy8XIEBxJUKyBK6eNGpApBX7gW6jArLDCYRTwyzHDZABEB1TetuIbp0Dd3kmei9d1RedzdTuBNiPSj20CHRgwEFsOFlhDi2qq-WadBVbuKfBBoce8TUGW_5-CoF0cTwufbyRqNBx625sXEhBqc-eDvpKJT-oLzf7wDoLWGhSZeWZWo3S64nsEvlu5bDJSwi6LMQ"]],c=a[Math.floor(Math.random()*a.length)],d=Math.round(Math.random());b.path("/trip/"+c[d]+"/"+c[1-d]+"/")}}]),angular.module("hellbergApp").controller("TripCtrl",["$scope","$routeParams","$q","$timeout","$location","RouteLoader","Questions","Speak","Soundtrack",function(a,b,c,d,e,f,g,h,i){a.points=10,a.loading=!0,f.fetch(b.dep_ref,b.dest_ref).then(function(b){g.fetch(b[0].name,b[1].name,[{lng:b[0].geometry.location.lng(),lat:b[0].geometry.location.lat()},{lng:b[1].geometry.location.lng(),lat:b[1].geometry.location.lat()}]).then(function(c){var f,g=5,h=200,j=50;a.loader_progress=0,a.loader_total=h;var k=function(){var b,h,k;i.play(),a.$apply(function(){a.loading=!1});var l=0,m=0,n=!1,o=g-1;a.show_input=!1,a.show_result=!1,a.submit=function(){var f=a.answer,g=c.get_question(o),h=g.validate_answer(f);h?e.path("/result/"+a.current_score+"/"+g.answer.answers[0]+"/"):(a.show_wrong=!0,a.show_input=!1,d(function(){a.show_wrong=!1,a.answer="",b()},3e3))},h=function(){n=!0,f.pause(),a.show_input=!0},b=function(){n=!1,k(),f.play(),a.show_input=!1},a.current_score=2*(g+1),a.trip_progress=0,a.question="",a.brake=function(){n?b():h(),$(".brake").addClass("pull"),d(function(){$(".brake").removeClass("pull")},100)};var p=50;k=function(){if(a.trip_progress=l/1e3/j*p*2,l+=p,l>=m)if(m+=1e3*j/g,a.current_score-=2,a.current_score<=0){var b=c.questions[0].answer.answers[0];e.path("/result/0/"+b+"/")}else{var f=c.get_question(o--).question;a.question=f}!n&&a.current_score>0&&d(k,p,!0)},k()};f=new Hyperlapse(document.getElementById("pano"),{use_lookat:!1,max_points:h,elevation:50,width:window.innerWidth,height:window.innerHeight,zoom:1,millis:j/h*1e3}),f.onLoadProgress=function(){a.$apply(function(){a.loader_progress++})},f.onError=function(b){a.$apply(function(){a.loader_progress++}),console.log(b)},f.onRouteComplete=function(){f.load()},f.onLoadComplete=function(){f.play(),k()},f.generate({route:b[2]})})})}]),angular.module("hellbergApp").controller("ResultCtrl",["$scope","$location","$routeParams",function(a,b,c){a.score=c.score,a.answer=c.answer}]);